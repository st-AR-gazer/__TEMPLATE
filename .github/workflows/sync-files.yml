name: Sync Files

on:
  push:
    paths:
      - 'src/Conditions/ARsSpecialUtils.as'
      - 'src/Conditions/Colors.as'
      - 'src/Conditions/Logging.as'
      - '_log().py'
      - '_build.py'

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Source Repository
        uses: actions/checkout@v3
        with:
          persist-credentials: false

      - name: Get Latest Commit Message
        id: commit
        run: echo "message=$(git log -1 --pretty=%B)" >> $GITHUB_ENV

      - name: Check for -halt
        id: check_halt
        run: |
          if [[ "${{ env.message }}" == -halt* ]]; then
            echo "Commit message starts with -halt, stopping workflow."
            exit 0
          fi

      - name: Setup Git
        run: |
          git config --global user.name 'github-actions'
          git config --global user.email 'github-actions@github.com'

      - name: Debug Environment Variables
        run: env

      - name: Sync Files to Target Repositories
        if: steps.check_halt.outcome == 'success'
        env:
          GH_PAT: ${{ secrets.GH_PAT_repo }}
        run: |
          REPOS=(
            "st-AR-gazer/___TESTING"
            "st-AR-gazer/_Altered-Nadeo_-_Random_Map_Picker"
            "st-AR-gazer/_CRP"
            "st-AR-gazer/_Auto-Enable-Specific-Ghost"
            "st-AR-gazer/_Reactor-Duration"
            "st-AR-gazer/_DragonYeet-GameData-Extration-Plugion"
            "st-AR-gazer/_Hightlight-Map-Borders"
            "st-AR-gazer/_Colorizer"
            "st-AR-gazer/_Blind"
            "st-AR-gazer/_RGB-Skids"
            "st-AR-gazer/_COTD-Style-Notifier"
            "st-AR-gazer/_Wings"
            "st-AR-gazer/_TrigramAndDossardRespawnOverride"
            "st-AR-gazer/_CSmScriptPlayer-Viewer"
          )
          for REPO in "${REPOS[@]}"; do
            git clone --depth 1 https://$GH_PAT@github.com/$REPO.git target-repo

            rsync -av --progress src/Conditions/ARsSpecialUtils.as target-repo/src/Conditions/ARsSpecialUtils.as
            rsync -av --progress src/Conditions/Colors.as target-repo/src/Conditions/Colors.as

            if [ -f target-repo/src/Conditions/Logging.as ]; then
              cp target-repo/src/Conditions/Logging.as target-repo/src/Conditions/Logging.old.as
              head -n 7 target-repo/src/Conditions/Logging.old.as > target-repo/src/Conditions/Logging.as
              tail -n +8 src/Conditions/Logging.as >> target-repo/src/Conditions/Logging.as
            else
              cp src/Conditions/Logging.as target-repo/src/Conditions/Logging.as
            fi

            rsync -av --progress _log().py target-repo/_log().py
            rsync -av --progress _build.py target-repo/_build.py

            cd target-repo
            git config --local user.name "github-actions"
            git config --local user.email "github-actions@github.com"
            git add .
            git commit -m "Sync files from source repository"
            git push https://$GH_PAT@github.com/$REPO.git main
            cd ..
            rm -rf target-repo
          done
# Repos not included in auto-sync:
# "st-AR-gazer/_Patch-Warner" # it has a different Logging.as structure...